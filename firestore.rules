rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- GLOBAL ALLOW (DEBUGGING) ---
    match /{document=**} {
      allow read, write: if true;
    }

    // --- 1. ACCESS KEYS (Fixes Login) ---
    // Allow checking if a specific key exists (needed for LoginView)
    match /access_keys/{key} {
      allow read, write: if true;
    }

    // --- 2. COMPETITION ENTRIES ---
    // "entries" contains the list of participants.
    match /competition/{stationId}/entries/{entryId} {
       allow read, write: if true;
    }

    // --- 3. LIVE SCORES (For Scoreboard) ---
    match /live_scores/{stationId} {
        allow read, write: if true;
    }

    // --- 4. BROADCASTS ---
    match /broadcasts/{document} {
      allow read, write: if true;
    }
    
    // --- 5. SYSTEM DOCS (Status & Config) ---
    match /system/{document} {
      allow read, write: if true;
    }

    // --- 7. RESULTS (Speed & Freestyle) ---
    // Required for AdminView and Judges
    match /results_speed/{document} {
        allow read, write: if true;
    }
    match /results_freestyle/{document} {
        allow read, write: if true;
    }

    // --- 6. STATION LOCKS ---
    // Critical for concurrency control
    match /station_locks/{stationId} {
        allow read, write: if true;
    }

    // Default Deny (Safety Net)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
